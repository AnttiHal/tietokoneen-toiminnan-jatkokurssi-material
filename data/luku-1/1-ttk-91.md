---
path: '/luku-1/1-ttk-91'
title: 'Esimerkkitietokone ttk-91'
hidden: false
---

<div>
<lead>
Tässä osiossa käymme läpi esimerkkitietokoneena käytettävän opetuskäyttöön suunnitellun tietokoneen ttk-91 perusrakenne ja sen ohjelmoinnin symbolisella konekielellä. Esittelemme myös ttk-91 emulaattorin Titokone ja ttk-91 symbolisen konekielen ohjelmoinnin harjoitteluympäristön TitoTrainer. 
</lead>
</div>


## Ttk-91
Yleiskuva ttk-91 arkkitehtuurissa annettiin Tietokoneen toiminnan perusteet MOOC'in luvussa 2. Jos nämä tiedot eivät ole ihan tuoreessa muistissa, voit haluta kerrata ne nyt. Näitä tietoja kerrataan ja täsmennetään nyt tässä.

## Rekisterit
Ttk-91 suorittimella on 8 konekäskyissä viitattavaa rekisteriä. Ne on nimetty R0-R7, mutta rekisterillä R6 on myös nimi SP (stack pointer) ja rekisterilla R7 nimi FP (frame pointer). Näitä kahta rekisteriä käytetään aliohjelmien toteutuksessa, mikä on seuraavan luvun (Luku 6) aihepiiri. Rekisterit R0-R5 ovat ns. työrekistereitä - niihin voidaan tallettaa kaikkien operaatioiden tulos ja ne voivat sisältää aritmeettis-loogisten operaatioiden ensimmäisen operandin. Rekistereitä R1-R5 voi käyttää myös indeksirekisterinä jälkimmäisen operandin arvon määrittämisessä. Jos jälkimmäisen operandin arvon määrittämisessä ei tarvitse (haluta) käyttää indeksirekisteriä, tämä tieto pitää koodata jollain tavoin konekäskyyn. Ttk-91 koneessa koodaus on tehty käyttämällä indeksirekisterin numeroa 0. Konekäskyssä oleva indeksirekisteri R0 tarkoittaa siis, että jälkimmäinen operandi määritellään ilman indeksirekisteriä (tai hypoteettisella 0-arvoisella indeksirekisterillä).

<!-- kuva: ch-5-1-a-ttk91-suoritin    -->

![Suoritin ja väylä tarkemmin. Väylä on jaettu kolmeen eri osaan, jotka ovat dataväylä, osoiteväylä ja kontrolliväylä. Suorittimen sisällä on neljä komponenttia, jotka ovat muistinhallintayksikkö MMU, rekisterit, aritmeettislooginen yksikkö ALU ja kontrolliyksikkö CU. Välimuisti puuttuu kuvasta kokonaan. Aritmeettisloogisessa yksikössä on esimerkin vuoksi mainittu ADD- ja MUL-suorituspiirit. Suorittimen komponentteja yhdistää niiden välinen omna sisäinen dataväylä ja niiden välisen kommunikoinnin toteuttavat kontrollisignaalit. Väylän lähellä on muistinhallintayksikkö MMU, jossa on sisäiset rajarekisterit Base ja Limit, muistin osoitusrekisteri MAR, muistin puskurirekisteri MBR ja väylän kontrollirekisteri BusCtl. Rekistereitä on kahdeksan kappaletta R0-R7. Kontrolliyksikkössä on neljä sisäistä rekisteriä. Ne ovat paikanlaskuri PC, käskyrekisteri IR, tilarekisteri SR ja tilapäisrekisteri TR.](./ch-5-1-a-ttk91-suoritin.svg)
<div>
<illustrations motive="ch-5-1-a-ttk91-suoritin"></illustrations>
</div>

Suorittimen kontrolliyksikössä on neljä nimettyä rekisteriä: PC, SR, IR ja TR). Paikanlaskuri PC (Program Counter) osoittaa aina seuravaksi suoritettavaan konekäskyyn. PC-rekisteriin voi konekäskyissä viitata epäsuorasti, esim. hyppykäsky asettaa PC:lle uuden arvon. Konekäskyillä voi ttk-91 koneessa PC:lle kuitenkin vain asettaa uusia arvoja, mutta sen arvoa ei voi lukea mitenkään.

Käskyrekisteri IR sisältää nyt suorituksessa olevan konekäskyn, joka on juuri haettu muistista. Rekisteri IR (Instruction Register) on valmiiksi langoitettu sillä tavoin, että käskyn eri kentät (operaatiokoodi, nimettyjen rekistereiden numerot, jne) ovat sieltä helposti luettavissa. Rekisteri TR (Temporary Register) on tilapäisrekisteri, jota käytetään jälkimmäisen operandin arvon laskennassa. Todellisissa suorittimissa on hyvin paljon tilapäisrekistereitä, joita käytetään eri tarkoituksiin käskyjen suorituksen aikana.

<!-- kuva: ch-5-1-a2-ttk91-tilarekisteri    -->
![Yksi pitkä laatikko, jonka edessä teksti SR ja sisällä bitit GELOZUMISPD???. Vasemmanpuolimmaisen bitin alla on sen numero 31, bitin Z alla sen numero 27 ja bitin D alla sen numero 21.](./ch-5-1-a2-ttk91-tilarekisteri.svg)
<div>
<illustrations motive="ch-5-1-a2-ttk91-tilarekisteri"></illustrations>
</div>

### Tilarekisteri TR
Tilarekisterillä SR (State Register) on monta tehtävää. Bitit P ja I rajoittavat suorittimen toimintaa tämän konekäskyn suorituksen yhteydessä. Bitti P (Privileged mode) kertoo, tapahtuuko tämän konekäskyn suoritus nyt etuoikeutetussa tilassa vai ei. Etuoikeutetussa tilassa voidaan suorittaa kaikkia konekäskyjä ja viitata mihin päin tahansa muistia. Bitti P laitetaan päälle esimerkiksi keskeytyskäsittelijäänsiirtymisen yhteydessä ja se palautetaan enmnalleen sieltä palatessa. 

Bitti I (Interrupts enable) kertoo, ovatko keskeytysten käsittelyt sallittuja tällä hetkellä (tämän konekäskyn suorituksen lopussa) vai ei. Jos jokin keskeytys tapahtuu ja bitti I on päällä (arvo 1), niin seuraavaksi suoritettava konekäsky ei olekaan PC:n osoittama käsky vaan kyseisen keskeytystyypin keskeytyskäsittelijän ensimmäinen käsky. Joissakin tapauksissa (yleensä käyttöjärjestelmän sisällä) halutaan keskeytymättä suorittaa jokin tietty konekäskyjen sarja alusta loppuun, mikä voidaan toteuttaa asettamalla I-bitti pois päältä (arvoon 0) vähäksi aikaa. Yleensä I-bittiä voi manipuloida vain etuoikeutetussa tilassa käyttöjärjestelmän koodissa.

Bitit G, E, L, O, Z, U, M ja S kertovat konekäskyn suorituksen päätyttyä, mitä suorittimella tapahtui tämän (tai muutaman aikaisemman) konekäskyn suorituksessa. Bitit G (Greater), E (Equal) ja L (Less) tallettavat vertailukäskyjen tuloksen. Vähän ehkä epäloogisesti niihin tallettuu myös tuloksen nollaan vertailu aritmetiikkaoperaatioiden jälkeen. 

Bitit O, Z, U ja M laitetaan päälle, jos käskyn suorituksessa tapahtui jokin keskeytyskäsittelyä vaativa virhetilanne. Bitti O (Overflow) viittaa kokonaislukujen ylivuotoon, kun aritmetiikkaoperaation tulos ei mahdu 32-bittiseen tulosrekisteriin. Tämä voisi tahatua esimerkiksi kertolaskun 1&nbsp;000&nbsp;000\*1&nbsp;000&nbsp;000 jälkeen. Bitti Z (divide by Zero) asetetaan päälle koknaislukujen nollallajaon yhteydessä. Kokonaislukuaritmetiikan mukaisesti nollalla jaon tulosta ei ole määritelty, eikä tulosta voi tällöin rekisterissä esittää. Bitti U (Unknown instruction) viittaa siihen, että operaatiokoodi oli epäkelpo. Kaikki 8-bittiset luvut (esim. luku nolla) eivät ole käytössä operaatiokoodeina. Bitti M (forbidden Memory address) laitetaan päälle, jos nyt suorituksessa olevan käskyn tai sen käyttämän datan yhteydessä on yritetty viitata sallitun muistialueen ulkopuolelle. 

Bitti S (Supervisor call) asetetaan päälle, jos suorituksessa oli SVC (SuperVisor Call) konekäsky. Sen käsittely on hyvin samanlainen virhetilanteiden kanssa.

Bitti I (device Interrupt) kertoo, että tämän konekäskyn suorituksen aikana jokin ulkoinen laite aiheutti I/O-laitekeskeytyksen. I/O-laitekeskeytys tarkoittaa, että kyseinen I/O-laite (esim. levyohjain tai verkkokortti) haluaa kertoa jotain sen laiteajurille. Tässä tapauksessa keskeytyskäsittelijä siirtää kyseisen laiteajurin Valmis suoritukseen (Ready) -tilaan, josta se ennemmin tai myöhemmin pääsee suoritukseen ja keskustelemaan laitteen kanssa jatkotoimista. Tällaisia ulkoisia keskeytystilanteita voi olla muitakin (esim. kellolaitekeskeytys), mutta niitä ei ole toteutettu ttk-91 määrittelyssä.

Kaikkien kesketystilanteiden (jokin biteistä G, E, L, O, Z, U, M, S on päällä ja bitti I on päällä) käsittely on samanlainen. Nykyiset PC ja SR:n arvot otetaan johonkin (esim. pinoon) talteen, SR:n P-bitti (etuoikeutettu suoritustila) asetetaan päälle ja PC:n arvoksi asetetaan kyseisen keskeytystyypin keskeytyskäsittelijän alkuosoite. Esimerkiksi, bitti Z on talletettu tilarekisterin bittiin numero 27, joten nollalla jako -virheen käsittelevän keskeytyskäsittelijän osoite löytyy keskusmuistista osoitteesta 27 (0x0000001B).

## Konekäskyt
Kaikilla ttk-91 koneen konekäskyillä on sama muoto. 32-bittinen käsky on jaettu viiteen kenttään. Operaatiokoodi (8 bittiä) kertoo, mikä operatio on kyseessä. Rekisteri Rj (3 bittiä) määrittelee ensimmäisen operandin ja on samalla tulosrekisteri kaikille aritmettis-loogisille käskyille. 

Jälkimmäinen operandi (tai käskyn kohdeosoite) määritellään kolmen kentän avulla. Moodi-kenttä (2 bittiä) kertoo kuinka jälkimmäinen operandi (tai käskyn kohdeosoite) muodostetaan rekisterin Rj (3 bittiä) ja vakio-osan ADDR (16 bittiä) avulla.

![Iso keltainen laatikko, jossa viisi kenttää kuvaamassa konekäskyn eri osia. Vasemmalta lukien OPCODE (8 bittiä), Rj (3 bittiä), moodi M (2 bittiä), Ri (3 bittiä) ja ADDR (16 bittiä). Alla esimerkki käsky ADD R2, =21(R5) joka lisää R2:n arvoon muistipaikan (R5+21) sisällön. Käskyn kentät vasemmalta ovat 00010001 (ADD), 010 (R2), 01 (suora muistiviite =), 101 (R5) ja 0x1B (21).](./ch-5-1-b-ttk91-konekaskyn-rakenne.svg)
<div>
<illustrations motive="ch-5-1-b-ttk91-konekaskyn-rakenne"></illustrations>
</div>

Todellisissa suorittimissa voi olla eri pituisia ja useamman tyyppisiä konekäskyjä. Käskyjen käsittely on kuitenkin helpompaa, jos käskyjen pituus on aina sama ja käskytyyppejäkin on vain muutama.

### Muistiin viittaustavat
Jälkimmäinen operandi voi olla joko indeksirekisterin ja vakio-osan summa (moodi 0), tämän summan osoittaman muistipaikan arvo (moodi 1, suora muistiosoitus), tai tämän summan osoittaman muistipaikan arvon osoittaman muistipaikan arvo (moodi 2, epäsuora muistiosoitus). Moodin arvo kertoo, kuinka monta muistinoutoa jälkimmäinen operandi vaatii sen jälkeen kun ensin on laskettu indeksirekisterin ja vakio-osan summa.

Jos halutaan indeksirekisterin ja vakio-osan summan asemesta käyttää vain indeksirekisterin arvoa, niin konekäskyssä vakio-osana on luku 0. Jos halutaan käyttää vain vakio-osaa ilman indeksirekisteriä, niin indeksirekisterikentässä on arvo 0. Tämän vuoksi ainoastaan rekistereitä R1-R5 voi käyttää indeksirekistereinä.

Store-käsky tallettaa aina muistiin. Tällöin moodi kentän arvo on aina yhtä pienempi, koska lopuksi tulee vielä yksi muistiin tallennus. Jos moodi on 0 (suora muistiviite, store), niin store-käsky tallettaa muistiosoitteeseen, joka on indeksirekisterin ja vakio-osan summa. Jos moodi on 1 (epäsuora muistiviite, store), niin store-käsky tallettaa muistiosoitteeseen, jonka osoite löytyy muistista indeksirekisterin ja vakio-osan summan osoittamasta muistipaikasta.

### Muistitilan käyttö
???

<!-- kuva: ch-5-1-c-ttk91-muistitilan-kaytto   # kalvo 5.12  -->

![Kuva muistitilankäytöstä ohjelmalle P. Vasemmalla on iso korkea palkki, joka kuvaa koko muistia, ylhäällä olevasta osoitteesta 0 osoitteeseen iso, joka voi olla esimerkiksi 4 194 303. Keskellä isoa muistia on ohjelmalle P varattu alue, jonka alkuun osoittaa rekisteri BASE ja jonka koko on rekisterissä LIMIT. Oikealla on tämä sama P:n muistialue suurennettuna, ylhäällä olevasta osoitteesta 0 osoitteeseen LIMIT-1. Ylimpänä osoitteesta 0 alkaen on ohjelman koodialue, ja sitten heti sen perään muistialue globaaleille muuttujille ja muille tietorakenteille. Seuraavaksi on pino aliohjelmien toteuttamista varten. Kaikkein alimpana on keko, joka sisältää dynaamisesti suoritusaikana varattuja ja vapautettuja muistialueita. Keossa on siis sekaisin varattuja ja vapaana olevia muistialueita. Pinorekisteri osoittaa pinon loppuun ja kekorekisteri keon alkuun. Näiden rekistereiden väliin jäävä osa on vapaata muistitilaa, johon sekä pino että keko voivat kasvaa.](./ch-5-1-c-ttk91-muistitilan-kaytto.svg)
<div>
<illustrations motive="ch-5-1-c-ttk91-muistitilan-kaytto"></illustrations>
</div>


## Tiedon esitysmuodot
???

## Kääntäjän ohjauskäskyt
???

## Symbolinen konekieli vs. "puhdas" konekieli
???


<!-- key-terminology -->
<text-box variant="example" name="Tärkeitä termejä">

### termi1 ?????
selitys1 ???

</text-box>

## Quizit 5.1 ?????
<!-- quiz 5.1.1 Pitääkö  -->

<div><quiznator id="5caf0493fd9fd71425c6d6c6"></quiznator></div>

